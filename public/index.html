<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bot Identity SaaS</title>
    <style>
        :root { --discord: #5865F2; --dark: #23272A; --card: #2C2F33; --text-muted: #b9bbbe; }
        body { background-color: var(--dark); color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; flex-direction: column; }

        .card { background-color: var(--card); padding: 2rem; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; }

        input { width: 100%; padding: 12px; margin-top: 10px; background: #1a1c1e; border: 1px solid #202225; color: white; border-radius: 5px; box-sizing: border-box; }
        label { display: block; margin-top: 15px; font-weight: bold; text-align: left; color: var(--text-muted); font-size: 0.8rem; }

        button { width: 100%; margin-top: 20px; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px; }
        button:disabled { background-color: #40444b; cursor: not-allowed; opacity: 0.7; }

        .btn-brand { background-color: var(--discord); }
        .btn-brand:hover:not(:disabled) { background-color: #4752c4; }
        .btn-login { background-color: #5865F2; font-size: 1rem; }

        #dashboard { display: none; }
        #login-panel { display: block; }

        .user-tag { background: #1a1c1e; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 15px; display: inline-block; border: 1px solid #5865F2;}
        .server-badge { background: #43b581; color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; margin-left: 5px; display: none; }

        .status { margin-top: 15px; min-height: 20px; font-size: 0.9rem; }
        .audit-box { margin-top: 25px; border-top: 1px solid #40444b; padding-top: 15px; text-align: left; }
        .audit-title { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: bold; }
        .log-entry { font-size: 0.8rem; background: #18191c; padding: 8px; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid var(--discord); }
        .log-time { color: #72767d; font-size: 0.7rem; display: block; margin-bottom: 2px; }


        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="login-panel" class="card">
    <h2>üîê Owner Login</h2>
    <p style="color: #b9bbbe; margin-bottom: 30px;">Login with Discord to verify you own the server.</p>
    <button class="btn-login" onclick="window.location.href='/api/login'">Login with Discord</button>
</div>

<div id="dashboard" class="card">
    <div class="user-tag" id="userInfo">Loading...</div>
    <h2>ü§ñ Bot Identity Manager</h2>

    <label>Server ID <span id="serverNameBadge" class="server-badge"></span></label>
    <input type="text" id="guildId" placeholder="Paste Guild ID...">

    <label>New Nickname</label>
    <input type="text" id="nickname" placeholder="e.g. My Server Bot">

    <label>New Avatar</label>
    <input type="file" id="avatar" accept="image/*">

    <button id="submitBtn" class="btn-brand" onclick="updateBot()">
        <span>Apply Changes</span>
    </button>

    <div class="status" id="status"></div>

    <div class="audit-box">
        <div class="audit-title">Recent Activity</div>
        <div id="auditList">
            <div style="color: #72767d; font-size: 0.8rem;">No recent actions found.</div>
        </div>
    </div>
</div>

<script>
    async function refreshData() {
        const req = await fetch('/api/user');
        const data = await req.json();

        if (data.user) {
            document.getElementById('login-panel').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('userInfo').innerText = `üë§ ${data.user.username}`;

            const logContainer = document.getElementById('auditList');
            if (data.logs && data.logs.length > 0) {
                logContainer.innerHTML = data.logs.map(log => {
                    const date = new Date(log.timestamp).toLocaleTimeString();
                    return `
                    <div class="log-entry">
                        <span class="log-time">${date} ‚Ä¢ Server: ${log.guildId}</span>
                        <span>${log.action}</span>
                    </div>`;
                }).join('');
            }
        }
    }

    window.onload = refreshData;

    async function updateBot() {
        const status = document.getElementById('status');
        const btn = document.getElementById('submitBtn');
        const btnText = btn.querySelector('span');
        const badge = document.getElementById('serverNameBadge');

        btn.disabled = true;
        btnText.innerText = "Processing...";

        if (!btn.querySelector('.spinner')) {
            const spinDiv = document.createElement('div');
            spinDiv.className = 'spinner';
            btn.prepend(spinDiv);
        }

        badge.style.display = 'none';

        const formData = new FormData();
        formData.append('guildId', document.getElementById('guildId').value);
        formData.append('nickname', document.getElementById('nickname').value);
        const fileInput = document.getElementById('avatar');
        if (fileInput.files[0]) formData.append('avatar', fileInput.files[0]);

        status.innerText = "";

        try {
            const req = await fetch('/api/update-profile', { method: 'POST', body: formData });
            const res = await req.json();

            btn.disabled = false;
            btnText.innerText = "Apply Changes";
            const spinner = btn.querySelector('.spinner');
            if (spinner) spinner.remove();

            if (res.success) {
                status.innerText = "‚úÖ Update Complete!";
                status.style.color = "#43b581";

                badge.innerText = `Verified: ${res.guildName}`;
                badge.style.display = "inline-block";

                refreshData();
            } else {
                status.innerText = "‚ùå " + (res.error || "Error");
                status.style.color = "#f04747";
            }
        } catch (e) {
            btn.disabled = false;
            btnText.innerText = "Apply Changes";
            if (btn.querySelector('.spinner')) btn.querySelector('.spinner').remove();

            status.innerText = "‚ùå Network Error";
            status.style.color = "#f04747";
        }
    }
</script>

</body>
</html>